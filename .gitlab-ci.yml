image: node:18

stages:
  - test

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

# Общий шаблон для всех тестов
.test_template: &test_template
  stage: test
  services:
    - docker:24-dind
  before_script:
    # Install Docker CLI
    - apt-get update && apt-get install -y docker.io
    # Install dependencies
    - npm ci
    # Install Supabase CLI globally
    - npm install -g supabase
    # Start Supabase local stack
    - supabase start
    # Extract keys from supabase status
    - export NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
    - export NEXT_PUBLIC_SUPABASE_ANON_KEY=$(supabase status | grep 'anon key' | cut -d':' -f2 | xargs)
    - export SUPABASE_SERVICE_ROLE_KEY=$(supabase status | grep 'service_role key' | cut -d':' -f2 | xargs)
    # Display environment info
    - echo "Supabase URL:" $NEXT_PUBLIC_SUPABASE_URL
    - echo "Supabase services started successfully"
    # Start Next.js dev server in background
    - npm run dev &
    - DEV_PID=$!
    # Wait for dev server to start
    - sleep 15
    # Check if dev server is running
    - curl -f http://localhost:3000 || (echo "Dev server failed to start" && exit 1)
  after_script:
    # Stop Supabase services
    - supabase stop || true
    # Kill dev server if still running
    - kill $DEV_PID || true
  only:
    - merge_requests
    - main
    - develop
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/

# Component тесты (быстрые, UI компоненты)
test:component:
  <<: *test_template
  script:
    - echo "Running component tests..."
    - npm run test:component
  artifacts:
    when: on_failure
    paths:
      - cypress/screenshots/
    expire_in: 1 week
    reports:
      junit: cypress/results/component-*.xml

# E2E тесты (медленные, полные сценарии)
test:e2e:
  <<: *test_template
  script:
    - echo "Running E2E tests..."
    - npm run test:e2e
  artifacts:
    when: on_failure
    paths:
      - cypress/screenshots/
      - cypress/videos/
    expire_in: 1 week
    reports:
      junit: cypress/results/e2e-*.xml
