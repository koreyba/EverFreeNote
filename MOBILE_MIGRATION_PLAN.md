# План подготовки архитектуры к React Native (Expo)

Цель: Унифицировать структуру проекта, разделив код на общее ядро (`core`), веб-часть (`ui/web`) и мобильную часть (`ui/mobile`), а также подготовить проект к внедрению Expo.

## Текущее состояние
- API и сервисы вынесены в `core`.
- Веб-компоненты находятся в корневой папке `components`.
- Типы находятся в корневой папке `types`.
- Папка `lib/` содержит смешанный код (Supabase клиент, провайдеры, утилиты).
- Существует папка `ui/web`, но она используется частично.

---

## Этап 1: Структурный рефакторинг (Symmetry)

> [!IMPORTANT]
> Выполняем поэтапно. После каждого подэтапа — коммит и проверка тестов.

### 1.1. Перенос компонентов
Переместить папку `components` внутрь `ui/web/`.
- [ ] Создать директорию `ui/web/components` (если нет).
- [ ] Переместить все содержимое текущей `components` в `ui/web/components`.
- [ ] Удалить корневую папку `components` после переноса.

### 1.2. Перенос типов
Переместить папку `types` внутрь `core/`.
- [ ] Переместить `types/` → `core/types/`.
- [ ] Удалить корневую папку `types` после переноса.

### 1.3. Консолидация `lib/`
Разобрать папку `lib/` и распределить содержимое по правильным слоям.
- [ ] `lib/supabase/` → `core/adapters/supabase/` (инфраструктурный код).
- [ ] `lib/providers/` → `ui/web/providers/` (есть дубликат, объединить).
- [ ] `lib/utils.ts` → `core/utils/` (объединить с существующими утилитами).
- [ ] `lib/enex/` → решить: это shared или web-only? Если shared → `core/enex/`.
- [ ] `lib/constants/` → `core/constants/`.
- [ ] Удалить папку `lib/` после распределения.

### 1.4. Обновление конфигурации TypeScript (`tsconfig.json`)
Настроить Path mapping (alias), чтобы импорты работали корректно.
- [ ] Обновить/добавить алиас `@/components/*` → `./ui/web/components/*`.
- [ ] Обновить алиас `@/types/*` → `./core/types/*`.
- [ ] Убедиться, что `@core/*` → `./core/*` работает.
- [ ] Убедиться, что `@ui/web/*` → `./ui/web/*` работает.
- [ ] Удалить устаревший алиас `@/lib/*` (если есть).

### 1.5. Обновление конфигурации Shadcn UI (`components.json`)
- [ ] Обновить пути в `components.json`:
  ```json
  {
    "aliases": {
      "components": "@ui/web/components",
      "ui": "@ui/web/components/ui"
    }
  }
  ```

### 1.6. Массовое обновление импортов
Использовать поиск/замену для обновления путей во всех файлах проекта.
- [ ] Обновить импорты в `app/` (Next.js pages).
- [ ] Обновить импорты внутри самих компонентов.
- [ ] Обновить импорты в тестах (`cypress/`).
- [ ] Обновить `cypress/tsconfig.json` с новыми alias.

### 1.7. Проверка работоспособности Web-версии
- [ ] Запуск `npm run dev`.
- [ ] Запуск `npm run type-check`.
- [ ] Запуск тестов `npm run test:component`.

---

## Этап 2: Изоляция платформо-зависимой логики

Убедиться, что хуки и утилиты, которые мы планируем переиспользовать, не содержат Web API напрямую.

### 2.1. Ревизия хуков
- [ ] **Анализ:** Просканировать хуки на наличие:
    - `window`, `document`, `localStorage` (браузерные API).
    - UI-библиотек, специфичных для веба (`sonner` для тостов, `lucide-react` иконок внутри логики).
    - `router` (Next.js router не будет работать в Expo).
- [ ] **Действия при обнаружении:**
    - Если логика смешанная (данные + UI): Разделить на два хука. Например, `useNotesCore` (только данные) и `useNotes` (веб-обертка с тостами).
    - Если зависимость небольшая (например, Storage): Вынести за интерфейс (Adapter Pattern), как уже сделано с `webStorageAdapter`.
    - Если это Toast/Alert: Прокидывать колбэки `onSuccess`, `onError` из хука, а UI-слой сам решит, как показать уведомление.

---

## Этап 3: Инициализация Expo (Mobile)

Создание базы для мобильного приложения.

### 3.1. Базовая настройка
- [ ] Инициализировать Expo проект.
- [ ] Добавить зависимости: `expo`, `react-native`, `@react-native-async-storage/async-storage`.
- [ ] Настроить `metro.config.js` для разрешения путей из корня (чтобы видеть `core/`).
- [ ] Создать `core/adapters/supabase/mobile.ts` — мобильный клиент Supabase с AsyncStorage.

---

## Ожидаемая архитектура папок

```text
/
├── core/                       # [SHARED] Чистая бизнес-логика
│   ├── adapters/               # Инфраструктурные адаптеры
│   │   └── supabase/
│   │       ├── client.ts       # Web клиент (browser)
│   │       └── mobile.ts       # Mobile клиент (AsyncStorage)
│   ├── services/               # Supabase сервисы (NoteService, AuthService)
│   ├── types/                  # TypeScript типы (перенесены из корня)
│   ├── utils/                  # Хелперы без DOM зависимостей
│   └── constants/              # Константы приложения
│
├── ui/                         # UI Слой
│   ├── web/                    # [WEB ONLY] Next.js специфика
│   │   ├── components/         # <-- Все компоненты (перенесены из корня)
│   │   │   ├── ui/             # Shadcn UI компоненты
│   │   │   └── features/       # Feature-компоненты (notes, etc.)
│   │   ├── hooks/              # Веб-хуки (с toast, router)
│   │   ├── adapters/           # Веб-адаптеры (localStorage)
│   │   └── providers/          # Веб-провайдеры (React Query, Theme)
│   │
│   └── mobile/                 # [MOBILE ONLY] Expo / React Native
│       ├── app/                # Expo Router / Screens
│       ├── components/         # Зеркальные компоненты на <View>
│       ├── hooks/              # Мобильные хуки
│       └── adapters/           # Адаптеры (AsyncStorage)
│
├── app/                        # [WEB ROUTING] Next.js App Router
│                               # Остается в корне (требование Next.js).
│
├── cypress/                    # Тесты (обновить пути импортов)
│
└── ...config files
```

---

## Риски и митигация

| Риск | Митигация |
|------|-----------|
| Много изменений за раз | Поэтапный подход: перенос → коммит → тесты |
| Сломанные Cypress тесты | Обновить `cypress/tsconfig.json` |
| Несовместимость Shadcn CLI | Обновить `components.json` до переноса |
