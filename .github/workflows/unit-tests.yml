name: Unit Tests

on:
  push:
    branches: [main, develop, github-actions-setup]
  pull_request:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Install mobile dependencies
        run: npm --prefix ui/mobile ci

      - name: Run Jest tests
        id: run-unit-tests
        continue-on-error: true
        run: npm --prefix ui/mobile test -- --verbose --ci --json --outputFile=results.json

      - name: Generate visual summary
        if: always()
        env:
          UNIT_STEP_OUTCOME: ${{ steps.run-unit-tests.outcome }}
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const summaryFile = process.env.GITHUB_STEP_SUMMARY;
          const reportPath = path.resolve('ui', 'mobile', 'results.json');
          const outcome = process.env.UNIT_STEP_OUTCOME || 'unknown';

          const counts = {
            suitesTotal: 0,
            suitesPassed: 0,
            suitesFailed: 0,
            testsTotal: 0,
            testsPassed: 0,
            testsFailed: 0,
            testsPending: 0,
            testsTodo: 0,
          };
          const failedTests = [];

          const stripAnsi = (value) => value.replace(/\u001b\[[0-9;]*m/g, '');

          if (fs.existsSync(reportPath)) {
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            counts.suitesTotal = report.numTotalTestSuites ?? 0;
            counts.suitesPassed = report.numPassedTestSuites ?? 0;
            counts.suitesFailed = report.numFailedTestSuites ?? 0;
            counts.testsTotal = report.numTotalTests ?? 0;
            counts.testsPassed = report.numPassedTests ?? 0;
            counts.testsFailed = report.numFailedTests ?? 0;
            counts.testsPending = report.numPendingTests ?? 0;
            counts.testsTodo = report.numTodoTests ?? 0;

            for (const suite of report.testResults ?? []) {
              for (const assertion of suite.assertionResults ?? []) {
                if (assertion.status !== 'failed') continue;
                const firstMessage = assertion.failureMessages?.[0] || 'No failure message available';
                const firstLine = stripAnsi(firstMessage).split('\n').find(Boolean) || 'No failure message available';
                failedTests.push({
                  file: suite.name || 'unknown-file',
                  fullName: assertion.fullName || assertion.title || 'unknown test',
                  message: firstLine,
                });
              }
            }
          }

          const headline = outcome === 'success' ? 'Unit Tests Passed' : 'Unit Tests Failed';

          let md = '';
          md += `## ${headline}\n\n`;
          md += '| Metric | Count |\n';
          md += '|---|---:|\n';
          md += `| Test Suites (total) | ${counts.suitesTotal} |\n`;
          md += `| Test Suites (passed) | ${counts.suitesPassed} |\n`;
          md += `| Test Suites (failed) | ${counts.suitesFailed} |\n`;
          md += `| Tests (total) | ${counts.testsTotal} |\n`;
          md += `| Tests (passed) | ${counts.testsPassed} |\n`;
          md += `| Tests (failed) | ${counts.testsFailed} |\n`;
          md += `| Tests (skipped) | ${counts.testsPending} |\n`;
          md += `| Tests (todo) | ${counts.testsTodo} |\n\n`;

          if (!fs.existsSync(reportPath)) {
            md += 'Jest JSON report was not found at `ui/mobile/results.json`.\n\n';
          }

          if (failedTests.length > 0) {
            md += '<details>\n';
            md += `<summary>Failed tests (${failedTests.length})</summary>\n\n`;
            for (const test of failedTests.slice(0, 30)) {
              md += `- **${test.fullName}**  \n`;
              md += `  \`${test.file}\`  \n`;
              md += `  ${test.message}\n`;
            }
            if (failedTests.length > 30) {
              md += `\n- ... and ${failedTests.length - 30} more\n`;
            }
            md += '\n</details>\n';
          }

          fs.appendFileSync(summaryFile, md);
          NODE

      - name: Upload unit test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-report-${{ github.run_id }}
          path: ui/mobile/results.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Mark job as failed when unit tests failed
        if: steps.run-unit-tests.outcome != 'success'
        run: exit 1
