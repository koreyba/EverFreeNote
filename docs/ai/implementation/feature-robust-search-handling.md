---
phase: implementation
title: Руководство по реализации
description: Технические заметки по реализации, паттерны и рекомендации по коду
---

# Руководство по реализации

## Структура кода
**Как организован код?**

Основные изменения коснутся:
- `core/utils/search.ts`: Функция `buildTsQuery`.
- `core/services/search.ts`: Класс `SearchService`.

## Заметки по реализации
**Ключевые технические детали:**

### Улучшение `buildTsQuery`

Текущая реализация выбрасывает ошибку, если строка пуста после очистки. Это поведение нужно изменить.

```typescript
// Текущее поведение
if (!sanitized) {
  throw new Error('Query is empty after sanitization')
}

// Желаемое поведение
if (!sanitized) {
  return null; // Или пустая строка, которую обработает сервис
}
```

Также нужно пересмотреть список удаляемых символов. Если мы хотим поддерживать поиск по коду, возможно, стоит заменять спецсимволы на пробелы, но делать это аккуратно, чтобы не создавать разрывов там, где их нет, или наоборот.

### Обработка в `SearchService`

В методе `searchNotes`:

```typescript
const tsQuery = buildTsQuery(query)
if (!tsQuery) {
  // Если запрос пустой или невалидный, возвращаем пустой результат сразу
  return { results: [], total: 0, method: 'fts' }
}
```

## Обработка ошибок
**Как мы обрабатываем сбои?**

- Если `buildTsQuery` не может построить валидный запрос, мы не должны "ронять" UI. Мы должны считать, что результатов нет.
- Логирование ошибок парсинга может быть полезно для отладки, но не должно быть видно пользователю как "крэш".

## Безопасность
**Какие меры безопасности приняты?**

- Мы продолжаем использовать параметризованные RPC вызовы.
- Мы не вставляем пользовательский ввод напрямую в SQL строку (кроме fallback, где используется `.ilike` с экранированием).
