---
phase: requirements
title: Очистка и схлопывание офлайн-очереди
description: Уменьшаем количество конфликтующих операций перед синхронизацией, чтобы исключить лишние запросы и дубликаты.
---

# Очистка и схлопывание офлайн-очереди

## Проблема
- Пока пользователь офлайн, в очередь попадают create/update/delete. Без предварительного схлопывания можно отправить на сервер взаимоисключающие операции: например, создать заметку, потом удалить её и всё равно отправить оба запроса.
- Для уже существующих заметок цепочка последовательных обновлений порождает множество `update` запросов вместо одного итогового.
- Для временных заметок (tempId) удаление без предшествующего create должно приводить к no-op, иначе мы будем пытаться удалить то, чего не существует.

## Цели
- Перед синхронизацией сокращать цепочки операций для одной заметки до минимального набора.
- Избегать отправки заведомо пустых сценариев (create → delete).
- Отправлять только финальное состояние при серии обновлений.

## Пользовательские сценарии
- Пользователь офлайн создаёт заметку, затем её удаляет — при выходе в онлайн ничего не создаётся.
- Пользователь офлайн трижды редактирует заметку — в онлайн уходит одно обновление с последними данными.
- Пользователь офлайн удаляет заметку, которую не создавал в этой сессии (нет create с tempId) — для tempId это no-op; для реальной заметки отправляем delete.

## Критерии успеха
- create+delete для одной заметки не приводит к вызовам API.
- Серия обновлений для заметки отправляет один update с последним payload.
- update+delete без create отправляет только delete.
- Все выходные элементы после компакта имеют статус `pending` и упорядочены по `clientUpdatedAt`.

## Ограничения и допущения
- SPA/Next export; серверная логика остаётся на Supabase/edge.
- Веб-офлайн — IndexedDB (fallback localStorage). Мобильный офлайн — отдельный адаптер (не часть этой задачи).
- Конфликтная политика на сервере остаётся last-write-wins; компактор лишь убирает явно лишние операции.

## Открытые вопросы
- Дополнительные правила для вложенных конфликтов не требуются — используем набор базовых правил выше.
