---
phase: requirements
title: Requirements & Problem Understanding
description: Clarify the problem space, gather requirements, and define success criteria
---

# Requirements & Problem Understanding: Offline WebView Bundle

## Problem Statement
**What problem are we solving?**

В мобильном приложении WYSIWYG-редактор работает внутри `WebView`, который загружает страницу редактора по URL (локальный dev-сервер в dev или облачный URL в prod). Когда устройство находится офлайн, `WebView` не может загрузить страницу → веб-редактор не инициализируется, мост сообщений не стартует, пользователь не может редактировать новую заметку (область редактирования не реагирует на ввод).

**Who is affected by this problem?**

- Мобильные пользователи, которые создают или редактируют заметки без доступа к интернету
- Пользователи в зонах с нестабильным интернет-соединением
- Все сценарии использования мобильного приложения в офлайн-режиме

**What is the current situation/workaround?**

В настоящее время мобильный клиент не содержит локальную копию статического бандла веб-редактора и полностью зависит от доступности сети/удалённого URL. Веб-страница должна отправить сообщение `READY` и затем обмениваться chunked-сообщениями с нативной частью — этого не происходит, если страница не загружена. Текущего работающего workaround нет.

## Goals & Objectives
**What do we want to achieve?**

### Primary Goals
- Обеспечить полноценную работу WYSIWYG-редактора в мобильном приложении в офлайн-режиме
- Включить статический бандл веб-редактора в мобильную сборку (APK/IPA)
- Сохранить единый источник правды (web-код) и функциональное паритетное поведение web/mobile

### Secondary Goals
- Предоставить fallback-механизм: при отсутствии локального бандла использовать remote URL
- Сохранить работоспособность dev-режима с локальным Next.js dev-сервером
- Обеспечить трассировку версии бандла редактора внутри мобильной сборки

### Non-Goals
- Реализация механизма динамического обновления assets без пересборки приложения (может быть реализовано позже)
- Полагаться на Service Worker в WebView как основную стратегию офлайна (ненадёжно)
- Дублирование исходников редактора (копируется только build-артефакт)

## User Stories & Use Cases
**How will users interact with the solution?**

### US-1: Создание заметки в офлайне
**Как** мобильный пользователь без доступа к сети  
**Я хочу** создать новую заметку с WYSIWYG-редактированием  
**Чтобы** не терять возможность работы с приложением в любых условиях

**Сценарий:**
1. Пользователь отключает сеть на устройстве
2. Открывает приложение и нажимает "Создать заметку"
3. Редактор загружается из локального бандла
4. Пользователь вводит текст, форматирует его (bold, italic, списки)
5. Автосохранение работает и сохраняет данные локально
6. При возвращении в список заметок изменения сохранены

### US-2: Редактирование существующей заметки в офлайне
**Как** мобильный пользователь  
**Я хочу** редактировать ранее созданную заметку без интернета  
**Чтобы** продолжить работу над заметкой в любое время

**Сценарий:**
1. Пользователь открывает существующую заметку в офлайне
2. Редактор загружается из локального бандла с содержимым заметки
3. Пользователь редактирует текст, добавляет изображения
4. Изменения автоматически сохраняются локально
5. События `CONTENT_CHANGED`/`CONTENT_ON_BLUR` корректно обрабатываются

### US-3: Fallback на remote URL при отсутствии локального бандла
**Как** разработчик или пользователь dev-сборки  
**Я хочу** чтобы приложение работало с remote URL, если локальный бандл недоступен  
**Чтобы** сохранить гибкость в разработке и не сломать существующие dev-процессы

### US-4: Работа с изображениями в офлайне
**Как** мобильный пользователь  
**Я хочу** видеть корректное отображение ранее просмотренных изображений в заметках  
**Чтобы** заметки выглядели полноценно даже без доступа к сети

**Known Limitation (Accepted for MVP)**: 
Некэшированные внешние изображения из Supabase Storage могут не отображаться офлайн из-за CORS (показывается placeholder). Изображения, просмотренные ранее online, будут кэшироваться WebView и работать офлайн.

**Rationale**: Основная функция (текстовое редактирование) работает идеально. Image caching layer добавляет значительную сложность и не является blocker для MVP. Можно добавить в v2 по обратной связи.

### Edge Cases
- Изображения с путями `/storage/v1/…` или `localhost` должны корректно переписываться
- Смена темы (dark/light) должна применяться к локально загруженному редактору
- Обработка ошибок при неудачной загрузке локального бандла с автоматическим fallback
- Корректная работа chunked-message bridge при локальной загрузке

## Success Criteria
**How will we know when we're done?**

### Measurable Outcomes
1. **Офлайн-функциональность**: При полном отсутствии сети на устройстве экран редактирования:
   - Загружает локальную страницу редактора и получает сообщение `READY`
   - Редактор отображается и позволяет ввод/редактирование WYSIWYG (вставка/удаление/курсор)
   - Автосохранение и события `CONTENT_CHANGED`/`CONTENT_ON_BLUR` отправляются в нативную часть и сохраняются локально

2. **Ресурсы**: Относительные/абсолютные URL картинок и шрифтов корректно загружаются в офлайне или правильно переписываются на Supabase origin

3. **Dev-режим не нарушен**: При разработке (`npm run dev`) WebView корректно подключается к локальному Next.js dev-серверу

4. **Fallback работает**: При отсутствии локального бандла приложение корректно использует remote URL

5. **CI-процесс**: Автоматизированная сборка: build web → copy artifacts → build mobile, итоговый APK/IPA содержит статический бандл

### Acceptance Criteria
- [ ] Мобильное приложение содержит статический бандл веб-редактора в assets (только необходимые файлы, ~3MB)
- [ ] WebView загружает локальный бандл в production, remote URL в dev mode
- [ ] Dev-режим (`__DEV__=true`): ВСЕГДА localhost dev-сервер (простое правило, hot reload работает)
- [ ] Production: ВСЕГДА пытается загрузить local bundle first, fallback на remote
- [ ] Все тесты из testing doc проходят успешно
- [ ] Размер APK увеличен на 3-4MB (в пределах приемлемого)
- [ ] Copy script включает validation и warnings для недостающих chunks
- [ ] Документация обновлена (README, DEVELOPMENT_SETUP) с known limitations

### Performance Benchmarks
- Время загрузки редактора из локального бандла: < 1 секунды
- Инициализация моста сообщений: < 500ms после загрузки страницы
- Размер добавленного бандла: ~3MB (несжатого), включая:
  - `editor-webview/index.html` (~9KB)
  - Только используемые JS chunks (~2.5MB)
  - CSS и шрифты (~0.5MB)
  - **Приемлемое увеличение APK**: 3-4MB (требует подтверждения stakeholder)

## Constraints & Assumptions
**What limitations do we need to work within?**

### Technical Constraints
- WebView имеет ограничения по загрузке локальных файлов (зависит от платформы Android/iOS)
- Service Worker в WebView работает ненадёжно и не должен использоваться как основная стратегия
- Next.js static export имеет ограничения (нет server-side rendering, API routes)
- Необходимо сохранить совместимость с существующим механизмом chunked messages

### Business Constraints
- Обновления редактора потребуют новой мобильной сборки (до реализации механизма динамического обновления)
- Размер APK увеличится, что может повлиять на скачивание приложения

### Time/Budget Constraints
- Решение должно быть реализовано без фундаментальной переработки архитектуры
- Использование существующих инструментов сборки (Next.js, React Native build процесс)

### Assumptions
- Статический экспорт Next.js страницы `/editor-webview` уже настроен (используется для Cloudflare Pages)
- Механизм `injectedJavaScriptBeforeContentLoaded` работает одинаково для локальных и remote URL
- Относительные пути в экспортированном бандле корректно резолвятся в WebView

## Questions & Open Items
**What do we still need to clarify?**

### Unresolved Questions
1. Какой именно путь использовать для хранения локального бандла в Android/iOS (assets vs bundle)?
2. Нужно ли реализовывать механизм проверки версии бандла и его обновления в runtime?
3. Как обрабатывать случай, когда локальный бандл поврежден или неполный?
4. Должны ли мы кэшировать изображения из Supabase Storage для полноценного офлайна?

### Items Requiring Stakeholder Input
1. Приемлемый размер увеличения APK (лимит)
2. Стратегия версионирования бандла и коммуникация версии пользователям
3. Приоритет между офлайн-функциональностью и размером приложения

### Research Needed
1. ~~Тестирование Next.js static export для страницы `/editor-webview` с Tiptap редактором~~ ✅ Уже работает (используется для Cloudflare Pages)
2. Проверка работы WebView с локальными файлами на реальных устройствах Android/iOS (не эмуляторы)
3. ~~**CORS-поведение**~~ ✅ Решено: принято limitation для MVP (uncached images не работают offline)
4. ~~Оценка итогового размера статического бандла~~ ✅ ~3MB после фильтрации неиспользуемых chunks
5. Тестирование `injectedJavaScriptBeforeContentLoaded` с `file://` URL (убедиться, что window.MOBILE_CONFIG доступен)
