---
phase: requirements
title: Требования к оффлайн-режиму
description: Полноценная работа без сети для веба и мобильных клиентов
---

# Требования и понимание задачи

## Problem Statement
**Какую проблему решаем и для кого**
- Сейчас приложение зависит от сети: без интернета нельзя читать, создавать или редактировать заметки, после обрыва синхронизация теряется. Затрагивает всех веб- и будущих мобильных пользователей.
- Пользовательский ориентир — поведение как в Evernote: открыть оффлайн, увидеть кеш заметок, создать/изменить, перезапустить устройство, не потерять данные, а при появлении сети — автоматический синк.
- Нужна единая логика для веба и мобильных клиентов с понятной политикой конфликтов и ограничением локального хранения.

## Goals & Objectives
**Что хотим получить**
- Основные цели:
  - Полноценный оффлайн-режим чтения/создания/редактирования заметок на вебе и в мобильном приложении.
  - Автосинхронизация при появлении сети с ретраями и бэк-оффом; сетевые ошибки не ломают UI.
  - Ограничение локального кеша ~100 МБ и управляемая очистка (LRU/давность обновления).
  - Стратегия конфликтов: last-write-wins; при явном конфликте создаётся копия заметки.
- Вторичные цели:
  - Минимальные UX-индикаторы оффлайна/состояния синка (если не блокирует — можно позже).
  - Подготовка интерфейсов для будущего локального поиска.
- Non-goals (вне рамок текущего этапа):
  - Оффлайн-поиск (FTS) — отложено, пока поиск только онлайн.
  - Серверные роуты/SSR для Next — остаёмся в SPA/export и Supabase/edge.

## User Stories & Use Cases
**Ключевые сценарии**
- Веб: пользователь открывает сайт без интернета, видит кеш заметок, создаёт/редактирует, закрывает и открывает снова — данные сохранены; при появлении сети — автоматический синк.
- Мобильное приложение: аналогично — оффлайн просмотр/создание/редактирование, переживает перезапуск, синхронизируется при онлайн.
- Ошибки сети: операции остаются pending до успешной отправки; при устойчивой неудаче пользователь информируется, данные не теряются.
- Поиск: пока работает только онлайн; оффлайн — сообщение «поиск недоступен».
- Перезапуск: очередь мутаций и кеш должны переживать рестарт клиента.

## Success Criteria
**Как поймём, что готово**
- Без сети: можно открыть приложение, увидеть кеш, создать/обновить/удалить заметку, перезапустить клиент и не потерять данные.
- При появлении сети: все pending-операции уходят в Supabase автоматически; при сбое — остаются в очереди, можно повторить.
- Лимит кеша ~100 МБ соблюдается, есть стратегия очистки; тяжёлые вложения не переполняют лимит.
- Конфликты: применяется last-write-wins; при обнаружении конфликта создаётся копия заметки для ручного разрешения.
- Поиск: онлайн FTS работает как сейчас; в оффлайне показывается понятное сообщение.

## Constraints & Assumptions
**Ограничения и допущения**
- Хранилище: веб — IndexedDB; мобильное — SQLite (предпочтительно) / AsyncStorage + NetInfo для статуса сети.
- Supabase free tier: учитываем лимиты хранения/запросов; не кешируем тяжёлые данные сверх лимита.
- Архитектура: SPA/Next export, без серверных роутов; взаимодействие через Supabase/edge functions при необходимости.
- Поиск: только онлайн на старте; локальный поиск — возможное расширение позже.
- Индикаторы статуса оффлайна/синка — можно добавить позже, если не блокирует поставку.

## Questions & Open Items
**Что ещё уточнить**
- Политика очистки кеша: достаточно LRU по updated_at или комбинировать с ограничением по числу записей?
- Формат уведомлений о долгих/неуспешных синках (toasts/баннеры) — нужен минимальный UX?
- Нужен ли отдельный лимит для вложений/медиа, если появятся? Пока считаем общим лимитом 100 МБ.
