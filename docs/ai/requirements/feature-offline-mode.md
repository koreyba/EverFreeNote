---
phase: requirements
title: Требования к оффлайн-режиму
description: Полноценная работа без сети для веба и мобильных клиентов
---

# Требования и понимание задачи

## Problem Statement
**Какую проблему решаем и для кого**
- Без интернета нельзя читать/создавать/редактировать заметки, изменения теряются при обрыве. Затрагивает всех веб- и будущих мобильных пользователей.
- Ожидание — поведение как в Evernote: открыть оффлайн, увидеть кеш, редактировать, пережить перезапуск, а при появлении сети — автосинк.
- Нужна единая логика для веба/мобайла, понятная политика конфликтов и ограничение локального хранения.

## Goals & Objectives
**Что хотим получить**
- Основные цели:
  - Полноценный оффлайн CRUD для заметок (веб и мобайл).
  - Автосинхронизация при появлении сети с ретраями/бэк-оффом, без сбоев UI.
  - Ограничение локального кеша ~100 МБ с управляемой очисткой (LRU/давность).
  - Конфликты: last-write-wins; при конфликте создаётся копия заметки.
  - Оффлайн-правки сразу видны в UI (overlay кеша поверх серверных данных), восстанавливаются после перезапуска.
- Вторичные цели:
  - Минимальные индикаторы оффлайна/статусов синка (уже есть баннер + лейблы pending/failed).
  - Подготовка интерфейсов для будущего локального поиска (пока онлайн).
- Non-goals (вне текущего этапа):
  - Оффлайн-поиск (FTS) — позже, сейчас только онлайн.
  - Серверные роуты/SSR для Next — остаёмся в SPA/export и Supabase/edge.

## User Stories & Use Cases
**Ключевые сценарии**
- Веб: без сети открыть приложение, увидеть кеш, создать/изменить, закрыть/открыть — данные на месте; при появлении сети — автосинк.
- Мобайл: аналогично (клиентский кеш/очередь), переживает перезапуск, синхронизируется при online.
- Ошибки сети: операции остаются pending до успешной отправки; при устойчивой неудаче — отображаем failed.
- Поиск: онлайн; оффлайн — сообщение о недоступности.
- Перезапуск: очередь мутаций и кеш переживают рестарт клиента и восстанавливают текущий вид списка/деталей (overlay).

## Success Criteria
**Как поймём, что готово**
- Оффлайн: можно открыть, прочитать кеш, создать/обновить/удалить, перезапустить и увидеть те же изменения (overlay).
- Онлайн: pending-операции уходят автоматически; при успехе overlay очищается; при ошибке остаётся pending/failed.
- Лимит кеша ~100 МБ соблюдается, есть стратегия очистки; тяжёлые вложения не переполняют лимит.
- Конфликты: last-write-wins, при конфликте создаётся копия.
- Поиск: онлайн FTS работает; оффлайн — понятное сообщение.

## Constraints & Assumptions
**Ограничения и допущения**
- Хранилище web: IndexedDB (fallback localStorage, но целевое — IndexedDB); mobile: SQLite/AsyncStorage + NetInfo (ещё не реализовано).
- Supabase free tier: учитываем лимиты; тяжёлые данные не кешируем сверх лимита.
- Архитектура: SPA/Next export, без серверных роутов; взаимодействие через Supabase/edge.
- Поиск: только онлайн на старте; локальный поиск — возможное расширение.
- Индикаторы статуса оффлайна/синка — минимальные (баннер + pending/failed лейблы).

## Questions & Open Items
**Что ещё уточнить**
- Mobile адаптер (SQLite/NetInfo): реализация или заглушка с TODO.
- Политика очистки кеша: достаточно LRU по updated_at (грубо по размеру JSON) или нужен более точный подсчёт?
- Нужны ли дополнительные индикаторы прогресса синка (toast/баннер) помимо лейблов?
