---
phase: requirements
title: Требования и понимание проблемы - Мобильное приложение на React Native + Expo
description: Разработка нативного мобильного приложения для EverFreeNote с использованием React Native и Expo
---

# Требования и понимание проблемы

## Постановка проблемы
**Какую проблему мы решаем?**

- Пользователи не могут полноценно работать с заметками на мобильных устройствах вне браузера
- Веб-версия в мобильном браузере имеет ограничения:
  - Нет офлайн-доступа к заметкам (браузерный кэш нестабилен)
  - Нет push-уведомлений
  - Неудобная работа с клавиатурой и текстом
  - Медленная загрузка при плохом интернете
  - Невозможно использовать нативные возможности платформы (биометрия, шаринг и т.д.)
- Текущая архитектура уже подготовлена к разделению на core/web/mobile слои, но нет мобильного UI

**Кто затронут этой проблемой?**
- Пользователи, которые часто работают с заметками на телефоне (дорога, встречи, быстрые записи)
- Пользователи с нестабильным интернетом
- Пользователи, которые хотят получать уведомления о синхронизации/изменениях

**Текущая ситуация/workaround:**
- Пользователи используют веб-версию в мобильном браузере
- Адаптивная верстка с использованием `useIsMobile()` хука (768px breakpoint)
- Sidebar превращается в drawer/sheet на мобильных устройствах

## Цели и задачи
**Чего мы хотим достичь?**

### Основные цели:
1. **Создать нативное мобильное приложение** на React Native + Expo для iOS и Android
2. **Переиспользовать весь core-слой** (services, types, utils) без дублирования кода
3. **Обеспечить идентичный UX** с мобильной версией сайта (те же компоненты, те же паттерны взаимодействия)
4. **Реализовать офлайн-режим** с синхронизацией через существующий offlineSyncManager
5. **Интегрировать OAuth** через expo-web-browser с deep linking

### Дополнительные цели:
- Добавить биометрическую аутентификацию (Face ID / Touch ID / отпечаток пальца)
- Поддержать темную/светлую тему с синхронизацией настроек
- Оптимизировать производительность для работы с большими наборами заметок (10000+)
- Добавить native sharing (поделиться заметкой)

### Не-цели (явно вне скоупа):
- Переписывание core-логики (она уже есть и работает)
- Создание отдельного backend для мобильного приложения (используем Supabase)
- Поддержка React Native Web (только нативные платформы)
- Создание планшетной версии в этой фазе (фокус на телефоны)

## Пользовательские истории и сценарии использования
**Как пользователи будут взаимодействовать с решением?**

### История 1: Установка и первый запуск
> Как новый пользователь, я хочу скачать приложение из App Store/Google Play, войти через Google OAuth и увидеть свои синхронизированные заметки, чтобы быстро начать работу

**Критический флоу:**
1. Установка приложения
2. Экран приветствия с кнопкой "Войти через Google"
3. Открытие Custom Tab/ASWebAuthenticationSession с OAuth URL
4. Редирект обратно в приложение через deep link `everfreenote://auth/callback`
5. Сохранение токенов в AsyncStorage
6. Загрузка и отображение заметок

### История 2: Создание и редактирование заметки офлайн
> Как пользователь, я хочу создать заметку в метро без интернета, и она автоматически синхронизируется при подключении

**Критический флоу:**
1. Нажатие кнопки "Новая заметка" без интернета
2. Открытие редактора с rich text форматированием (TipTap)
3. Ввод текста, заголовка, добавление тегов
4. Автосохранение в локальную БД (AsyncStorage или SQLite)
5. Добавление операции в offlineQueue
6. При появлении интернета - автоматическая синхронизация
7. Уведомление об успешной синхронизации

### История 3: Поиск заметок
> Как пользователь, я хочу быстро найти заметку по ключевым словам или тегам

**Критический флоу:**
1. Открытие поискового экрана
2. Ввод текста в поисковую строку
3. Мгновенная фильтрация списка заметок (debounced)
4. Фильтрация по тегам через chip-компоненты
5. Отображение результатов с highlight найденного текста

### История 4: Работа с тегами
> Как пользователь, я хочу фильтровать заметки по тегам и быстро добавлять/удалять теги

**Критический флоу:**
1. Просмотр списка всех тегов в sidebar/drawer
2. Нажатие на тег - фильтрация заметок
3. В редакторе заметки - добавление нового тега через input
4. Удаление тега свайпом или кликом на X

### История 5: Экспорт заметок в ENEX
> Как пользователь, я хочу экспортировать свои заметки в формате ENEX для резервного копирования

**Критический флоу:**
1. Открытие меню экспорта
2. Выбор заметок (все или выбранные)
3. Запуск экспорта (используя core/enex/export-service.ts)
4. Сохранение файла в Downloads через expo-file-system
5. Возможность поделиться файлом через Share API

## Критерии успеха
**Как мы поймем, что задача выполнена?**

### Функциональные критерии:
- ✅ Приложение успешно компилируется и запускается на iOS и Android
- ✅ OAuth-авторизация работает через Google с deep linking
- ✅ CRUD операции с заметками выполняются корректно
- ✅ Офлайн-режим работает: создание, редактирование, удаление заметок
- ✅ Синхронизация офлайн-очереди происходит автоматически при появлении интернета
- ✅ Поиск по заметкам работает (FTS -> ILIKE fallback через core/services/search.ts)
- ✅ Теги отображаются и фильтруются корректно
- ✅ Rich text редактор работает со всеми форматированиями (TipTap)
- ✅ Экспорт/импорт ENEX работает

### Производительность:
- ✅ Список из 1000+ заметок рендерится плавно (60 FPS) через виртуализацию
- ✅ Время запуска приложения < 2 секунд (на современных устройствах)
- ✅ Переключение между заметками < 100ms
- ✅ Автосохранение срабатывает через 500ms после последнего изменения

**Производительность на старых устройствах:**
- ✅ Целевые устройства: iPhone 8 (2017), Samsung Galaxy A50 (2019)
- ✅ Время запуска на старом устройстве: < 3 секунды
- ✅ Scroll FPS на старом устройстве: >= 30 FPS
- ✅ Приложение стабильно работает при 2GB RAM

### UX критерии:
- ✅ UI идентичен мобильной веб-версии (те же цвета, отступы, шрифты)
- ✅ Темная/светлая тема переключается корректно
- ✅ Навигация интуитивна (drawer для sidebar, bottom tabs для основных разделов)
- ✅ Все интерактивные элементы имеют размер >= 44x44px (iOS HIG)
- ✅ Клавиатура не перекрывает важные элементы (KeyboardAvoidingView)

### Технические критерии:
- ✅ 100% переиспользование core-слоя (никакого дублирования бизнес-логики)
- ✅ Все платформенные зависимости идут через адаптеры (storage, navigation, oauth)
- ✅ Покрытие тестами >= 80% для компонентов
- ✅ Приложение проходит проверку в App Store и Google Play
- ✅ Crash reporting настроен и работает
- ✅ OTA updates через EAS работают корректно

## Ограничения и допущения
**В каких рамках мы должны работать?**

### Технические ограничения:
- **React Native версия:** >= 0.74 (последняя стабильная с новой архитектурой)
- **Expo SDK:** >= 51 (поддержка всех нужных нативных модулей)
- **Supabase JS SDK:** v2.x (та же версия, что и в web)
- **TipTap:** Потребуется адаптация для React Native (возможно, использование react-native-webview или альтернативного редактора)
- **TanStack Query:** Полная совместимость с React Native
- **AsyncStorage:** Максимум 6MB на iOS, для больших данных потребуется SQLite

### Платформенные ограничения:
- **iOS:** минимальная версия iOS 13+
- **Android:** минимальная версия Android 8.0 (API level 26)
- **Deep linking:** Нужно зарегистрировать `everfreenote://` схему
- **OAuth redirect:** Настроить в Supabase новый redirect URI для мобильного

### Бизнес-ограничения:
- **Бюджет:** $0 (используем free tier Expo EAS, Supabase free tier)
- **Сроки:** Фокус на MVP, без сложных фич (уведомления, биометрия - в следующих фазах)
- **Команда:** 1 разработчик, должен максимально переиспользовать код

### Допущения:
- Core-слой уже готов к переиспользованию (проверено в feature-core-web-mobile-split.md)
- TipTap можно адаптировать для React Native или заменить на react-native-rich-editor
- Пользователи согласны на хранение данных в AsyncStorage (или SQLite для большого объема)
- OAuth через expo-web-browser корректно работает с Supabase (документация есть)
- Мобильное приложение использует тот же Supabase проект, что и веб (никаких отдельных сред)

### Стратегия обновлений:
- **OTA updates:** Bug fixes и minor changes через EAS Update (не требуют App Store review)
- **Binary updates:** Major версии и нативные изменения через App Store/Google Play
- **Совместимость:** Обязательная обратная совместимость данных между версиями
- **Rollback:** Возможность откатить OTA update в случае критических ошибок

### Мониторинг и отладка:
- **Crash reporting:** Sentry (бесплатный tier: 5k events/month)
- **Логирование:** react-native-logs с уровнями (error, warn, info, debug)
- **Performance monitoring:** Expo Application Services (встроенный)
- **Analytics:** Отложено до post-MVP (Firebase Analytics или Amplitude)

## Вопросы и открытые задачи
**Что еще нужно уточнить?**

### Технические вопросы:
1. **TipTap в React Native:** Нужно ли использовать WebView для TipTap или искать нативную альтернативу?
   - ✅ **РЕШЕНО:** Используем **@10play/tentap-editor** - современный редактор на базе TipTap, адаптированный для React Native
   - Преимущества: почти идентичный API к TipTap, нативная производительность, активная поддержка (1k+ stars, обновления 2024-2025)
   - GitHub: https://github.com/10play/10tap-editor
   
2. **Хранилище данных:** AsyncStorage (6MB limit) или SQLite для больших наборов заметок?
   - ✅ **РЕШЕНО:** Используем **SQLite сразу** (expo-sqlite) для надежного хранения больших объемов данных
   - AsyncStorage только для настроек UI и кэша

3. **Виртуализация списка:** Использовать FlashList (от Shopify) вместо FlatList?
   - ✅ **РЕШЕНО:** Да, FlashList показывает лучшую производительность

4. **Изображения в заметках:** Как хранить загруженные изображения офлайн?
   - ✅ **РЕШЕНО:** Использовать expo-file-system для кэширования + Supabase Storage

### UX вопросы:
1. **Навигация:** Bottom tabs или только drawer?
   - ✅ **РЕШЕНО:** Bottom tabs для основных разделов (Заметки, Поиск, Профиль) + drawer для фильтров/тегов

2. **Жесты:** Swipe-to-delete для заметок?
   - ✅ **РЕШЕНО:** Нет, не используем swipe-to-delete (упрощаем UX)

3. **Pull-to-refresh:** Нужен ли?
   - ✅ **РЕШЕНО:** Да, стандартный паттерн для обновления данных

### Бизнес-вопросы:
1. **Публикация:** Публиковать ли сразу в обоих сторах или начать с одного?
   - *Предложение:* Сначала TestFlight/Internal Testing, потом публичный релиз

2. **Версионирование:** Как синхронизировать версии web и mobile?
   - *Решение:* Независимые версии, core-версия как peer dependency

3. **Аналитика:** Нужна ли встроенная аналитика (Firebase Analytics)?
   - *Решение:* Не в MVP, добавим позже

### Следующие шаги:
- [x] Выбрать rich text редактор (@10play/tentap-editor)
- [x] Определить хранилище данных (SQLite)
- [x] Определить UX паттерны (bottom tabs, pull-to-refresh)
- [ ] **ПРИОРИТЕТ 1:** Создать proof-of-concept для @10play/tentap-editor (2 дня)
- [ ] **ПРИОРИТЕТ 1:** Зарегистрировать `everfreenote://auth/callback` в Supabase redirect URIs
- [ ] **ПРИОРИТЕТ 2:** Протестировать OAuth flow с Supabase в Expo
- [ ] **ПРИОРИТЕТ 2:** Настроить deep linking схему в app.json
- [ ] **ПРИОРИТЕТ 3:** Создать базовую структуру проекта mobile app
- [ ] **ПРИОРИТЕТ 3:** Адаптировать core-адаптеры для React Native
- [ ] **ПРИОРИТЕТ 4:** Настроить Sentry для crash reporting

---

## Приложение: Сравнение технологий

### Совместимость используемых библиотек с React Native:

| Библиотека | Web версия | React Native | Совместимость | Примечания |
|------------|------------|--------------|---------------|------------|
| **Supabase JS** | ✅ v2.87.1 | ✅ v2.87.1 | 100% | Требует кастомный storage adapter (AsyncStorage) |
| **TanStack Query** | ✅ v5.90.12 | ✅ v5.90.12 | 100% | Полная совместимость |
| **TipTap** | ✅ v3.13.0 | ⚠️ Частично | ~30% | Заменяется на @10play/tentap-editor (совместимый API) |
| **React Hook Form** | ✅ v7.x | ✅ v7.x | 100% | Полная совместимость |
| **date-fns** | ✅ v4.1.0 | ✅ v4.1.0 | 100% | Полная совместимость |
| **DOMPurify** | ✅ isomorphic-dompurify v2.34.0 | ❌ Нет | 0% | Нужна замена (expo-html-sanitizer или react-native-sanitizer) |
| **Radix UI** | ✅ Все компоненты | ❌ Нет | 0% | Нужна замена на React Native Paper, NativeBase или кастомные компоненты |
| **Tailwind CSS** | ✅ v3.x | ⚠️ NativeWind | ~70% | NativeWind v4 поддерживает большинство классов |
| **Lucide Icons** | ✅ lucide-react | ✅ lucide-react-native | 100% | Есть нативная версия |

### Рекомендации по замене компонентов:

#### UI-библиотека для React Native:
**Варианты:**
1. **NativeWind v4** + кастомные компоненты (аналог shadcn/ui для RN)
   - ✅ Максимально близко к текущему web UI
   - ✅ Использует Tailwind-подобный синтаксис
   - ⚠️ Нужно создавать все компоненты с нуля

2. **React Native Paper** (Material Design 3)
   - ✅ Готовая библиотека компонентов
   - ✅ Хорошая документация
   - ❌ Дизайн не совпадает с текущим веб-приложением

3. **NativeBase v3**
   - ✅ Готовая библиотека
   - ⚠️ Тяжелая, влияет на размер bundle

**Рекомендация:** NativeWind v4 + кастомные компоненты (максимальное сходство с web)

#### Rich Text Editor:
**Выбрано:** ✅ **@10play/tentap-editor**

**Преимущества:**
- ✅ Основан на TipTap - почти идентичный API
- ✅ Нативная производительность (WebView только для рендеринга)
- ✅ Поддержка всех основных форматирований (bold, italic, headings, lists, links, images)
- ✅ TypeScript из коробки
- ✅ Активная поддержка (GitHub: 1k+ stars, обновления 2024-2025)
- ✅ Можно переиспользовать знания TipTap из web-версии

**Альтернативы (не выбраны):**
1. **TipTap через WebView** - медленная работа, проблемы с клавиатурой
2. **react-native-pell-rich-editor** - устаревший, базовый функционал
3. **Aztec Editor** (WordPress) - сложная интеграция, избыточный для наших нужд
4. **react-native-cn-quill** - тяжелый, WebView based

**GitHub:** https://github.com/10play/10tap-editor

#### Навигация:
**Варианты:**
1. **React Navigation v6** (стандарт для RN)
   - ✅ Наиболее популярное решение
   - ✅ Хорошая документация
   
2. **Expo Router** (file-based routing)
   - ✅ Автоматическая генерация роутов
   - ✅ Совместим с Next.js паттернами

**Рекомендация:** Expo Router (схожесть с Next.js)

---

## Связанные документы
- [feature-core-web-mobile-split.md](./feature-core-web-mobile-split.md) - Архитектура разделения на слои
- [feature-mobile-adaptation.md](./feature-mobile-adaptation.md) - Адаптивная веб-версия
- [feature-offline-mode.md](./feature-offline-mode.md) - Офлайн-режим (переиспользуется в mobile)

