---
phase: testing
title: Тестирование оффлайн-режима
description: Подход, сценарии и покрытие
---

# Стратегия тестирования

## Цели покрытия
- Юнит: ядро кеша, очереди, синк-менеджер — стремимся к 100% по критичной логике.
- Интеграционные: цепочки offline → enqueue → online sync, ретраи, обработка конфликтов, лимит кеша.
- E2E: основные пользовательские потоки на вебе (и позже на мобайле) — работа без сети, перезапуск, автоматический синк.

## Юнит-тесты
- Cache:
  - запись/чтение/обновление;
  - соблюдение лимита 100 МБ, удаление старых записей (LRU/updated_at);
  - поведение при попытке записать, если места нет.
- Mutation Queue:
  - enqueue для create/update/delete, tempId для create;
  - смена статусов pending/failed/synced;
  - идемпотентность при повторных enqueue/dequeue.
- Sync Manager:
  - drainQueue батчами, успех помечает synced и очищает очередь;
  - ошибки сети → retry с backoff, остановка при отсутствии прогресса;
  - корректная отметка failed без зацикливания.

## Интеграционные тесты
- Offline режим: создать/обновить/удалить заметку без сети → запись в кеш и очередь → после смены на online всё уходит на сервер.
- Перезапуск: pending записи сохраняются после рестарта клиента и синкаются при появлении сети.
- Лимит кеша: при переполнении старые записи удаляются, новые сохраняются.
- Конфликты: last-write-wins по updated_at; при конфликте создаётся копия заметки.
- Поиск: в оффлайне — отображается сообщение «поиск недоступен»; онлайн — работает FTS.

## E2E (web)
- Сценарий: открыть без сети, увидеть кеш, создать заметку, перезапустить браузер — заметка на месте; включить сеть — заметка уходит в Supabase.
- Массовые обновления: несколько pending операций, часть успешна, часть падает — проверка повторных попыток и отсутствия дубликатов.
- Удаление: удалённая заметка исчезает из кеша и очереди после успешного синка.

## Данные и стабы
- Mock Supabase (или test project) для сетевых ответов: успех, 4xx, 5xx, таймауты.
- Стаб IndexedDB/SQLite для проверки лимитов и LRU.
- Генерация заметок разного размера для проверки 100 МБ лимита.

## Отчётность
- CI: `npm run type-check`, компонентные/интеграционные тесты, e2e для ключевых сценариев.
- Покрытие: критичные части core (cache/queue/sync) — максимально возможное; UI-хуки — smoke.
- Ручная проверка: оффлайн/онлайн переключение, индикаторы состояния (когда появятся), UX без подвисаний.
