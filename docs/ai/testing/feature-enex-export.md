---
phase: testing
title: Testing Strategy
description: Define testing approach, test cases, and quality assurance
---

# Testing Strategy: Evernote Export (.enex)

## Test Coverage Goals
**What level of testing do we aim for?**

- Unit test coverage target: 100% для нового кода
- Integration test scope: Критические пути + обработка ошибок
- End-to-end test scenarios: Основные пользовательские сценарии
- Alignment with requirements/design acceptance criteria: Все критерии успеха должны быть покрыты тестами

## Unit Tests
**What individual components need testing?**

### Date Formatter (`lib/enex/date-formatter.ts`)
- [ ] Test case 1: Конвертация ISO timestamp в формат Evernote
  - Входные данные: `2023-01-01T12:00:00Z`
  - Ожидаемый результат: `20230101T120000Z`
- [ ] Test case 2: Конвертация Date объекта
  - Входные данные: `new Date('2023-01-01T12:00:00Z')`
  - Ожидаемый результат: `20230101T120000Z`
- [ ] Test case 3: Обработка различных timezone
  - Проверка корректной конвертации в UTC
- [ ] Test case 4: Обработка граничных случаев (миллисекунды)
  - Проверка округления до секунд

### EnexBuilder (`lib/enex/enex-builder.ts`)
- [ ] Test case 1: Генерация XML для заметки без изображений
  - Проверка структуры XML
  - Проверка экранирования специальных символов
  - Проверка CDATA обертки для контента
- [ ] Test case 2: Генерация XML для заметки с изображениями
  - Проверка включения ресурсов
  - Проверка base64 кодирования
  - Проверка MIME типов
- [ ] Test case 3: Генерация XML для заметки без тегов
  - Проверка отсутствия тегов в XML
- [ ] Test case 4: Генерация XML для заметки с пустым содержимым
  - Проверка обработки пустого контента
- [ ] Test case 5: Экранирование XML специальных символов
  - Проверка экранирования `<`, `>`, `&`, `"`, `'`
- [ ] Test case 6: Генерация полного .enex файла с несколькими заметками
  - Проверка структуры en-export
  - Проверка export-date атрибута

### ImageDownloader (`lib/enex/image-downloader.ts`)
- [ ] Test case 1: Извлечение URL изображений из HTML
  - HTML с одним изображением
  - HTML с несколькими изображениями
  - HTML без изображений
  - HTML с относительными URL (должны быть пропущены или обработаны)
- [ ] Test case 2: Скачивание изображения и конвертация в base64
  - Успешное скачивание
  - Проверка MIME типа
  - Проверка base64 формата
- [ ] Test case 3: Обработка ошибок скачивания
  - HTTP 404 ошибка
  - Сетевые ошибки
  - Таймауты
  - Возврат null при ошибках
- [ ] Test case 4: Определение MIME типа
  - Из Content-Type заголовка
  - Из расширения файла
  - Fallback на image/png
- [ ] Test case 5: Извлечение имени файла из URL
  - Различные форматы URL
  - Обработка URL без имени файла

### ExportService (`lib/enex/export-service.ts`)
- [ ] Test case 1: Экспорт заметок без изображений
  - Получение заметок через NoteService
  - Генерация XML
  - Создание Blob файла
- [ ] Test case 2: Экспорт заметок с изображениями
  - Интеграция с ImageDownloader
  - Обработка изображений для каждой заметки
- [ ] Test case 3: Обработка прогресса экспорта
  - Вызов callback прогресса для каждой заметки
  - Корректные значения currentNote и totalNotes
- [ ] Test case 4: Обработка ошибок получения заметок
  - Ошибка NoteService
  - Показ понятного сообщения об ошибке
- [ ] Test case 5: Обработка пустого списка заметок
  - Генерация валидного .enex файла с пустым en-export
- [ ] Test case 6: Batch processing изображений
  - Ограничение параллельных запросов
  - Корректная обработка батчей

## Integration Tests
**How do we test component interactions?**

- [ ] Integration scenario 1: Полный flow экспорта без изображений
  - Mock NoteService
  - Вызов ExportService
  - Проверка валидности XML
  - Проверка создания Blob
- [ ] Integration scenario 2: Полный flow экспорта с изображениями
  - Mock NoteService с заметками с изображениями
  - Mock fetch для скачивания изображений
  - Проверка включения изображений в XML
- [ ] Integration scenario 3: Обработка ошибок при скачивании изображений
  - Mock ошибок fetch
  - Проверка продолжения экспорта
  - Проверка пропуска проблемных изображений
- [ ] Integration scenario 4: Экспорт большого количества заметок
  - Тестирование производительности
  - Проверка прогресса
  - Проверка использования памяти

## End-to-End Tests
**What user flows need validation?**

- [ ] User flow 1: Экспорт выбранных заметок
  - Нажатие кнопки экспорта
  - Открытие диалога выбора заметок
  - Выбор заметок через чекбоксы
  - Использование кнопки "Выбрать все"
  - Подтверждение выбора и запуск экспорта
  - Ожидание завершения экспорта
  - Проверка скачивания файла
  - Проверка имени файла
- [ ] User flow 2: Экспорт с индикацией прогресса
  - Проверка отображения прогресса
  - Проверка обновления прогресса
  - Проверка завершения экспорта
- [ ] User flow 3: Обработка ошибок в UI
  - Проверка отображения ошибок
  - Проверка предупреждения о пропущенных изображениях
  - Проверка возможности повторной попытки
- [ ] User flow 4: Выбор заметок в диалоге
  - Проверка отображения карточек заметок (как в левом баре)
  - Проверка работы чекбоксов
  - Проверка кнопки "Выбрать все"
  - Проверка отображения количества выбранных заметок
  - Проверка валидации (нельзя экспортировать без выбора)
- [ ] User flow 5: Импорт экспортированного файла обратно
  - Экспорт выбранных заметок
  - Импорт того же файла
  - Проверка сохранения данных
  - Проверка отображения изображений
- [ ] User flow 6: Открытие экспортированного файла в Evernote
  - Экспорт заметок
  - Импорт в Evernote (если доступно)
  - Проверка совместимости
- [ ] User flow 7: Graceful degradation при ошибках изображений
  - Экспорт заметок с проблемными изображениями
  - Проверка продолжения экспорта
  - Проверка предупреждения о пропущенных изображениях
  - Проверка, что остальные изображения экспортированы корректно

## Test Data
**What data do we use for testing?**

- Test fixtures and mocks
  - Mock заметки с различными типами контента
  - Mock изображения для скачивания
  - Тестовые HTML с изображениями
  - Тестовые .enex файлы для сравнения

- Seed data requirements
  - Заметки без изображений
  - Заметки с одним изображением
  - Заметки с несколькими изображениями
  - Заметки без тегов
  - Заметки с пустым содержимым
  - Заметки со специальными символами в названии/контенте

- Test database setup
  - Использование существующей тестовой БД
  - Очистка данных после тестов (если необходимо)

## Test Reporting & Coverage
**How do we verify and communicate test results?**

- Coverage commands and thresholds
  - `npm run test -- --coverage` для проверки покрытия
  - Цель: 100% покрытие для нового кода
  - Проверка покрытия всех веток (branches)

- Coverage gaps
  - Документировать любые пропущенные участки кода с обоснованием
  - Edge cases, которые сложно протестировать

- Links to test reports or dashboards
  - Результаты тестов в CI/CD pipeline
  - Coverage reports в artifacts

- Manual testing outcomes and sign-off
  - Ручное тестирование экспорта в различных браузерах
  - Проверка совместимости с Evernote
  - Проверка производительности с большими данными

## Manual Testing
**What requires human validation?**

- UI/UX testing checklist
  - [ ] Кнопка экспорта видна и доступна (под кнопкой импорта)
  - [ ] Диалог выбора заметок открывается корректно
  - [ ] Карточки заметок выглядят как в левом баре
  - [ ] Чекбоксы работают корректно
  - [ ] Кнопка "Выбрать все" работает корректно
  - [ ] Количество выбранных заметок отображается корректно
  - [ ] Индикация прогресса отображается корректно
  - [ ] Сообщения об ошибках понятны
  - [ ] Предупреждения о пропущенных изображениях отображаются
  - [ ] Файл скачивается с правильным именем
  - [ ] Accessibility: кнопка доступна через клавиатуру
  - [ ] Accessibility: screen reader читает прогресс
  - [ ] Accessibility: чекбоксы доступны через клавиатуру

- Browser/device compatibility
  - [ ] Chrome/Edge (Chromium)
  - [ ] Firefox
  - [ ] Safari (если доступно)
  - [ ] Мобильные браузеры (опционально)

- Smoke tests after deployment
  - [ ] Экспорт работает в production окружении
  - [ ] Нет ошибок в консоли
  - [ ] Файлы скачиваются корректно

## Performance Testing
**How do we validate performance?**

- Load testing scenarios
  - Экспорт 10 заметок
  - Экспорт 100 заметок
  - Экспорт 1000 заметок
  - Экспорт с большим количеством изображений (50+ на заметку)

- Stress testing approach
  - Тестирование с очень большими изображениями
  - Тестирование с медленным интернет-соединением
  - Тестирование с таймаутами

- Performance benchmarks
  - Экспорт 100 заметок с изображениями: <30 секунд
  - Экспорт 1000 заметок без изображений: <10 секунд
  - Использование памяти: <500MB для 1000 заметок

## Bug Tracking
**How do we manage issues?**

- Issue tracking process
  - Создание issues в GitHub/GitLab для найденных багов
  - Приоритизация критических багов
  - Фиксация багов перед релизом

- Bug severity levels
  - **Critical:** Экспорт не работает вообще
  - **High:** Экспорт работает, но данные теряются
  - **Medium:** Экспорт работает, но есть проблемы с производительностью
  - **Low:** Мелкие UI проблемы

- Regression testing strategy
  - Запуск всех тестов перед каждым релизом
  - Проверка регрессий в существующем функционале импорта
  - Проверка совместимости экспортированных файлов
