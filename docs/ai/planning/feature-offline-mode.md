---
phase: planning
title: План работ — offline mode
description: План внедрения офлайн-режима с кэшем, очередью мутаций и синхронизацией.
---

# План работ

## Этапы высокого уровня
1) **Подготовка инфраструктуры** — готово  
   - [x] Базовые типы/интерфейсы core (CachedNote, Mutation, SyncState, StorageAdapter, SyncManager).  
   - [x] Адаптеры хранилища: web (IndexedDB + fallback), mobile (SQLite/AsyncStorage + NetInfo).  
   - [x] Лимит кеша ~100 МБ и политика очистки (LRU/updated_at).
2) **Очередь и кеш** — готово  
   - [x] Mutation queue с tempId и статусами pending/failed/synced.  
   - [x] Read-through кеш и проверка лимита.  
   - [x] UI-хуки работают через очередь/кеш (оптимистичные обновления, overlay/selectedNote).  
3) **Синхронизация** — готово  
   - [x] Синк-менеджер: batch/serial, retry с backoff, остановка при отсутствии прогресса.  
   - [x] Авто-триггеры синка (online, таймер).  
   - [x] Обработка конфликтов: last-write-wins + дубликат при конфликте.  
4) **UX/поведение** — готово  
   - [x] Сообщение об офлайне/недоступности поиска.  
   - [x] Отображение pending/failed.  
   - [x] Проверка перезапуска: данные и очередь сохраняются.  
5) **Тестирование** — в работе  
   - [ ] Юнит-тесты cache/queue/sync.  
   - [ ] Интеграционные сценарии offline→online, лимит кеша, конфликты.  
   - [ ] E2E (web): офлайн использование, перезапуск, авто-синк.  
6) **Компактация очереди** — готово  
   - [x] `compactQueue` (core) по правилам: create+delete→noop, create+updates→create с последним payload, updates→последний update, update+delete→delete (tempId без create→noop).  
   - [x] Вызов compaction в SyncManager перед drainQueue и перезапись очереди.  
   - [x] Статусы на выходе обнуляются до pending, порядок сохраняется по clientUpdatedAt.

## Декомпозиция задач (актуальное состояние)
- **Кеш (IndexedDB/SQLite)**: CRUD, лимит 100 МБ, LRU/updated_at, измерение объёма. — готово (web), mobile adapter в отдельной задаче.
- **Очередь**: enqueue/dequeue, tempId, статусы, сортировка в хранилище, идемпотентность. — готово.
- **Синк**: batch, backoff, маркер прогресса, перевод failed в повторные попытки при новом online, overlay после удачного синка. — готово.
- **Конфликты**: политика last-write-wins, дубликат при конфликте, логирование. — готово.
- **UX**: баннер офлайна, индикаторы pending/failed, overlay для локальных изменений, счётчики в Sidebar. — готово.
- **Компактация**: compactQueue + интеграция в SyncManager. — готово.
- **Тесты**: юниты и интеграция — не сделаны, E2E — не сделаны.

## Примечания
- Мобильный адаптер (SQLite/AsyncStorage) и связанные тесты — вне текущего скопа, отдельная задача.  
- Политика last-write-wins остаётся базовой; при конфликте создаём копию заметки (поведение уже в core).  
- Для web fallback на localStorage работает только с ограниченным объёмом и без индексов.
