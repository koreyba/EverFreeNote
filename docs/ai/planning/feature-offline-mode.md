---
phase: planning
title: План работ по оффлайн-режиму
description: Этапы, задачи и приоритеты
---

# План работ

## Этапы высокого уровня
1) Подготовка инфраструктуры
   - [x] Ввести типы/интерфейсы core (CachedNote, Mutation, SyncState, StorageAdapter, SyncManager).
   - [x] Подготовить адаптеры хранилища: web (IndexedDB), mobile (SQLite/AsyncStorage + NetInfo).
   - [x] Закрепить лимит кеша ~100 МБ и политику очистки (LRU/updated_at).

2) Очередь и кеш
   - [x] Реализовать mutation queue с tempId, статусами pending/failed/synced.
   - [x] Реализовать кеш с read-through и проверкой лимита.
   - [ ] Обновить UI-хуки для работы через очередь/кеш (оптимистичные оффлайн-обновления списков/selectedNote).

3) Синхронизация
   - [x] Синк-менеджер: batch/serial, retry с backoff, остановка при отсутствии прогресса.
   - [x] Авто-триггеры синка (online, таймер).
   - [x] Обработка конфликтов: last-write-wins + создание копии при конфликте.

4) UX/поведение
   - [x] Сообщение об оффлайне/недоступности поиска (минимальное).
   - [x] Отображение pending/failed (можно отложить, если не блокирует).
   - [ ] Проверка перезапуска: данные/очередь сохраняются и восстанавливают актуальный вид списков/деталей.

5) Тестирование
   - [ ] Юнит-тесты cache/queue/sync.
   - [ ] Интеграционные сценарии offline→online, лимит кеша, конфликты.
   - [ ] E2E (web): оффлайн использование, перезапуск, авто-синк.

## Декомпозиция задач
- Кеш (IndexedDB/SQLite): CRUD, лимит 100 МБ, LRU/updated_at, измерение объёма.
- Очередь: enqueue/dequeue, tempId, сериализация в хранилище, идемпотентность.
- Синк: батчи, backoff, маркеры прогресса, перевод failed в повторные попытки при новом online; очистка overlay/кеша после успешного drain.
- Конфликты: политика last-write-wins, дубликат при конфликте, логирование.
- Поиск: оставить только онлайн; оффлайн-поиск обозначить как future flag.
- UI: использование статусов isOffline/pendingCount/hasFailed; сообщение «поиск недоступен оффлайн»; оптимистичное отображение оффлайн правок (overlay поверх server data).
- Логи/метрики (минимально): счётчик неудачных попыток синка, время последнего успешного синка.

## Риски и смягчение
- Измерение объёма кеша: использовать подсчёт размера записей; при ошибке считать по числу записей как fallback.
- Потери данных при сбое синка: не удалять из очереди до подтверждения сервера; хранить клиентский updated_at.
- Производительность: избегать больших серийных операций в UI-потоке (IndexedDB/SQLite — батчи и воркеры, если потребуется).
- Различия web/mobile: всё, что возможно, держать в ядре; в адаптерах — только особенности платформ.

## Исправленные баги (2025-12)

### 1. Бесконечный цикл создания/удаления заметок
**Причина**: `popQueueBatch` удалял items из очереди ДО обработки, нарушая требование "не удалять до подтверждения".
**Решение**: Добавлены методы `getPendingBatch` (читает без удаления) и `removeQueueItems` (удаляет после успеха).

### 2. Race condition при переходе online
**Причина**: `drainQueue` вызывался параллельно из разных источников.
**Решение**: Добавлен флаг `draining` для предотвращения параллельного выполнения.

### 3. Memory leak в syncManager
**Причина**: При пересоздании syncManager старые подписки на network status не очищались.
**Решение**: Добавлен `dispose()` в useEffect cleanup.

### 4. Отсутствие оптимистичного удаления
**Причина**: При офлайн-удалении заметка не скрывалась из UI сразу.
**Решение**: Добавлен флаг `deleted` в CachedNote, `applyNoteOverlay` теперь фильтрует удалённые.

### 5. Производительность IndexedDB
**Улучшение**: Добавлены индексы по `status` и `clientUpdatedAt` для быстрого поиска pending items.
